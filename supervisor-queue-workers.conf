# Laravel Queue Workers Supervisor Configuration
# Optimized for non-blocking operations and optimal performance
#
# IMPORTANT: Update the following placeholders before deployment:
# - Replace /path/to/your/app with your actual application path (e.g., /var/www/your-app)
# - Replace www-data with your web server user (e.g., nginx, apache, or your app user)
# - Adjust numprocs (number of processes) based on your server resources
# - Update log file paths if needed
#
# Installation:
# 1. Copy this file to /etc/supervisor/conf.d/laravel-queues.conf
# 2. Update paths and user as needed
# 3. Run: sudo supervisorctl reread
# 4. Run: sudo supervisorctl update
# 5. Run: sudo supervisorctl start laravel-queues:*

# ============================================================================
# HIGH-PRIORITY QUEUE WORKER
# ============================================================================
# Handles critical retries (RetryPayslipEmailJob) and urgent operations
# Priority: Highest - These jobs must be processed quickly
# Resource: Moderate memory, fast processing
# ============================================================================
[program:queue-high-priority]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work redis --queue=high-priority --sleep=3 --tries=1 --max-jobs=1000 --timeout=120 --memory=256
directory=/path/to/your/app
autostart=true
autorestart=true
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-high-priority.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
numprocs=4
user=www-data
environment=APP_ENV=production,QUEUE_CONNECTION=redis

# ============================================================================
# EMAILS QUEUE WORKER
# ============================================================================
# Handles email/SMS sending operations (SendPayslipJob batches)
# Priority: High - Most frequent operations
# Resource: Moderate memory, high throughput needed
# ============================================================================
[program:queue-emails]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work redis --queue=emails --sleep=3 --tries=1 --max-jobs=1000 --timeout=120 --memory=256
directory=/path/to/your/app
autostart=true
autorestart=true
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-emails.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
numprocs=8
user=www-data
environment=APP_ENV=production,QUEUE_CONNECTION=redis

# ============================================================================
# PDF PROCESSING QUEUE WORKER
# ============================================================================
# Handles PDF operations (SplitPdfJob, RenameEncryptPdfJob batches)
# Priority: Medium - Can run in parallel with emails
# Resource: Higher memory for PDF operations, longer timeout
# ============================================================================
[program:queue-pdf-processing]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work redis --queue=pdf-processing --sleep=3 --tries=1 --max-jobs=500 --timeout=300 --memory=512
directory=/path/to/your/app
autostart=true
autorestart=true
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-pdf-processing.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=5
numprocs=4
user=www-data
environment=APP_ENV=production,QUEUE_CONNECTION=redis

# ============================================================================
# PROCESSING QUEUE WORKER
# ============================================================================
# Handles heavy operations (imports, exports, reports, bulk operations)
# Priority: Low - Can wait, but needs resources when running
# Resource: High memory, very long timeout for heavy processing
# ============================================================================
[program:queue-processing]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work redis --queue=processing --sleep=3 --tries=1 --max-jobs=500 --timeout=600 --memory=512
directory=/path/to/your/app
autostart=true
autorestart=true
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-processing.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=5
numprocs=4
user=www-data
environment=APP_ENV=production,QUEUE_CONNECTION=redis

# ============================================================================
# DEFAULT QUEUE WORKER
# ============================================================================
# Handles general operations and fallback jobs
# Priority: Low - General purpose queue
# Resource: Moderate memory, standard timeout
# ============================================================================
[program:queue-default]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work redis --queue=default --sleep=3 --tries=1 --max-jobs=1000 --timeout=120 --memory=256
directory=/path/to/your/app
autostart=true
autorestart=true
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-default.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
numprocs=4
user=www-data
environment=APP_ENV=production,QUEUE_CONNECTION=redis

# ============================================================================
# QUEUE WORKER GROUP
# ============================================================================
# Groups all queue workers for easy management
# Usage:
#   sudo supervisorctl start laravel-queues:*
#   sudo supervisorctl stop laravel-queues:*
#   sudo supervisorctl restart laravel-queues:*
#   sudo supervisorctl status laravel-queues:*
# ============================================================================
[group:laravel-queues]
programs=queue-high-priority,queue-emails,queue-pdf-processing,queue-processing,queue-default
priority=999
